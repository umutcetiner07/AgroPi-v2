<script>
/*
  AgroPi - temiz JS bloğu (sandbox/testnet, appId opsiyonel)
  Yapılacak: mevcut <script>...</script> bloğunu tamamen silip
  bununla değiştir. Önce dosyanın yedeğini al.
*/

const $ = (sel) => document.querySelector(sel);
const log = (msg) => {
  const box = $("#logBox");
  const prefix = "[" + new Date().toLocaleTimeString() + "] ";
  if (box) {
    box.textContent = (box.textContent === "—" ? "" : box.textContent + "\n") + prefix + msg;
    box.scrollTop = box.scrollHeight;
  } else {
    console.log(prefix + msg);
  }
};
const setStatus = (txt, type="") => {
  const el = $("#status");
  if (el) {
    el.textContent = txt;
    el.className = "status " + (type || "");
  } else {
    log("STATUS: " + txt);
  }
};
const summarizeCart = () => {
  const name = $("#name")?.value?.trim();
  const product = $("#product")?.value;
  const quantity = Number($("#quantity")?.value || 0);
  const price = Number($("#price")?.value || 0);
  if (!product || !quantity || !price) return "Boş";
  const total = (quantity * price).toFixed(4);
  return `${name || "—"}: ${product} x ${quantity} kg @ ${price} Pi = ${total} Pi`;
};

// Yıl
if ($("#y")) $("#y").textContent = new Date().getFullYear();

// Form submit / kayıt
const farmerForm = $("#farmerForm");
if (farmerForm) {
  farmerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      name: $("#name")?.value.trim(),
      phone: $("#phone")?.value.trim(),
      region: $("#region")?.value,
      product: $("#product")?.value,
      quantity: Number($("#quantity")?.value),
      price: Number($("#price")?.value),
      notes: $("#notes")?.value.trim(),
    };
    if (!payload.name || !payload.phone || !payload.region || !payload.product || !payload.quantity || !payload.price) {
      setStatus("Lütfen gerekli alanları doldurun.", "warn");
      return;
    }
    if ($("#cartBox")) $("#cartBox").textContent = summarizeCart();
    setStatus("Kayıt gönderiliyor...", "warn");
    log("Kayıt API çağrısı başlıyor.");
    try {
      // TODO: üretimde kendi backend URL'ini koy
      const res = await fetch("/api/farmers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("Kayıt başarısız: " + res.status);
      const data = await res.json().catch(()=> ({}));
      setStatus("Kayıt alındı. ID: " + (data.id || "—"), "ok");
      log("Kayıt başarılı. ID: " + (data.id || "—"));
    } catch (err) {
      console.error(err);
      setStatus("Kayıt hatası: " + err.message, "err");
      log("Kayıt hatası: " + err.message);
    }
  });
}

// Temizle butonu
if ($("#clearBtn")) {
  $("#clearBtn").addEventListener("click", () => {
    $("#farmerForm")?.reset();
    if ($("#cartBox")) $("#cartBox").textContent = "Boş";
    setStatus("Form sıfırlandı.");
    log("Form temizlendi.");
  });
}

/* ------------- Pi SDK bölüm (temiz, sandbox/testnet, appId opsiyonel) ------------- */

const PI_APP_ID = ""; // Eğer App ID'yi bulduğunda buraya yazabilirsin. Şimdilik boş bırak.
const PI_SDK_URL = "https://sdk.minepi.com/pi-sdk.js";
let piUser = null;
let piAccessToken = null;

function ensurePiSdk() {
  return new Promise((resolve, reject) => {
    if (window.Pi) return resolve(window.Pi);
    const s = document.createElement("script");
    s.src = PI_SDK_URL;
    s.async = true;
    s.onload = () => {
      if (window.Pi) {
        resolve(window.Pi);
      } else {
        reject(new Error("Pi SDK yüklendi ama window.Pi bulunamadı"));
      }
    };
    s.onerror = () => reject(new Error("Pi SDK yüklenemedi"));
    document.head.appendChild(s);
  });
}

async function initPi() {
  const Pi = await ensurePiSdk();
  try {
    // TEST için sandbox:true. Prod'ta bunu false veya kaldır.
    Pi.init({ version: "2.0", sandbox: true });
    log("Pi SDK init edildi (sandbox:true).");
    return Pi;
  } catch (e) {
    log("Pi init hatası: " + (e?.message || e));
    throw e;
  }
}

async function piLogin() {
  try {
    const Pi = await initPi();
    const scopes = ["payments","username","wallet_address"];
    log("authenticate çağrılacak. appId: " + (PI_APP_ID || "(yok)"));
    let authRes;
    if (PI_APP_ID) {
      authRes = await Pi.authenticate(scopes, onIncompletePaymentFound, { appId: PI_APP_ID });
    } else {
      // appId opsiyonel deneyimi
      authRes = await Pi.authenticate(scopes, onIncompletePaymentFound);
    }
    piUser = authRes.user;
    piAccessToken = authRes.accessToken;
    $("#userBox").textContent = `${piUser?.username || "—"} (wallet: ${piUser?.wallet?.address || "—"})`;
    $("#loginBtn").style.display = "none";
    $("#logoutBtn").style.display = "inline-block";
    setStatus("Pi oturumu açıldı.", "ok");
    log("Auth başarılı. Username: " + (piUser?.username || "—"));
    // Backend'e token doğrulama isteği (isteğe bağlı)
    fetch("/api/pi/verify-token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accessToken: piAccessToken })
    }).catch(()=>{ log("verify-token isteği atıldı (catch)."); });
  } catch (err) {
    setStatus("Giriş iptal/başarısız: " + (err?.message || err), "warn");
    log("Auth hata/iptal: " + ((err && err.message) || err));
    console.error(err);
  }
}

async function piLogout() {
  piUser = null;
  piAccessToken = null;
  if ($("#userBox")) $("#userBox").textContent = "Giriş yapılmadı";
  $("#loginBtn").style.display = "inline-block";
  $("#logoutBtn").style.display = "none";
  setStatus("Oturum kapatıldı.");
  log("Oturum kapatıldı.");
}

// Eksik ödeme kontrol callback'i
async function onIncompletePaymentFound(payment) {
  log("Eksik ödeme bulundu: " + (payment?.identifier || JSON.stringify(payment)));
  try {
    await fetch("/api/pi/complete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ payment })
    }).catch(()=>{ log("complete çağrısı gönderildi, hata yutuldu."); });
    log("Eksik ödeme bildirildi backend'e.");
  } catch (e) {
    log("Eksik ödeme notify hatası: " + (e?.message || e));
  }
}

async function startPayment() {
  const product = $("#product")?.value;
  const quantity = Number($("#quantity")?.value);
  const price = Number($("#price")?.value);
  if (!piUser) {
    setStatus("Önce Pi ile giriş yapın.", "warn");
    log("startPayment: piUser yok");
    return;
  }
  if (!product || !quantity || !price) {
    setStatus("Ürün/Miktar/Fiyat eksik.", "warn");
    log("startPayment: eksik alan (product/quantity/price)");
    return;
  }
  const amount = Number((quantity * price).toFixed(6));
  const memo = `AgroPi sipariş: ${product} x ${quantity}kg`;
  const metadata = { product, quantity, unit_price: price };

  setStatus("Ödeme başlatılıyor...", "warn");
  log(`Ödeme isteği: ${amount} Pi - ${memo} | metadata: ${JSON.stringify(metadata)}`);

  try {
    const Pi = await initPi();
    const paymentData = { amount, memo, metadata };
    log("createPayment çağrılıyor. paymentData=" + JSON.stringify(paymentData));

    const payment = await Pi.createPayment(paymentData, {
      onReadyForServerApproval: async (paymentId) => {
        log("onReadyForServerApproval: " + paymentId);
        // backend yoksa bu fetch 404 dönebilir; hata yutuluyor.
        await fetch("/api/pi/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId })
        }).catch(()=>{ log("approve fetch çağrısı yapıldı (hata yutuldu)."); });
      },
      onReadyForServerCompletion: async (paymentId, txid) => {
        log("onReadyForServerCompletion: " + paymentId + " txid=" + (txid || "—"));
        await fetch("/api/pi/complete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId, txid })
        }).catch(()=>{ log("complete fetch çağrısı yapıldı (hata yutuldu)."); });
      },
      onCancel: (paymentId) => {
        setStatus("Ödeme iptal edildi: " + paymentId, "warn");
        log("Ödeme iptal: " + paymentId);
      },
      onError: (err, payment) => {
        setStatus("Ödeme hatası: " + (err?.message || JSON.stringify(err)), "err");
        log("Ödeme hatası objesi: " + JSON.stringify(err));
        console.error(err, payment);
      }
    });

    setStatus("Ödeme oluşturuldu: " + (payment?.identifier || "—"), "ok");
    log("createPayment başarılı. payment objesi: " + JSON.stringify(payment));
  } catch (err) {
    setStatus("Ödeme başlatılamadı: " + ((err && err.message) || err), "err");
    log("startPayment hata: " + ((err && err.message) || err));
    console.error(err);
  }
}

// UI event bağlamaları
if ($("#loginBtn")) $("#loginBtn").addEventListener("click", piLogin);
if ($("#logoutBtn")) $("#logoutBtn"].addEventListener("click", piLogout);
if ($("#payBtn")) $("#payBtn").addEventListener("click", startPayment);

// İlk sepet özeti
if ($("#cartBox")) $("#cartBox").textContent = summarizeCart();

// Kullanıcıya öneri: Pi Browser dışında test etme uyarısı
if (!navigator.userAgent || !/PiBrowser/i.test(navigator.userAgent)) {
  log("Uyarı: Pi Browser kullanılmıyor olabilir. Gerçek testler için Pi Browser'da açın.");
  setStatus("Uyarı: Pi Browser'da test etmeniz önerilir.", "warn");
}
</script>
