<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Pi Network SDK Hybrid Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; min-width: 300px; max-width: 500px; }
    .close { float: right; cursor: pointer; font-weight: bold; }
    .error-msg { color: red; font-weight: bold; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Pi Network SDK Hybrid Demo</h1>

  <nav>
    <button id="btnLoadSdk">SDK Yükle</button>
    <button id="btnInit">Init</button>
    <button id="btnLogin">Login</button>
    <button id="btnPay">Ödeme</button>
  </nav>

  <h2>Üyelik Paneli</h2>
  <form id="membershipForm">
    <input type="text" id="username" placeholder="Kullanıcı Adı" required />
    <button type="submit">Kayıt Ol / Giriş Yap</button>
  </form>
  <div id="membershipStatus"></div>

  <h2>Loglar</h2>
  <pre id="logs"></pre>
  <div id="errorDisplay" class="error-msg"></div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h3>Modal Başlık</h3>
      <p id="modalMessage"></p>
    </div>
  </div>

  <script>
    // ------------------- CONFIG -------------------
    const APP_ID = "agropi-e19dcb997017c03d";
    const envParam = new URLSearchParams(window.location.search).get("env");
    const isNetlify = window.location.hostname.includes("netlify.app");
    const isSandbox = envParam === "sandbox" || (!envParam && isNetlify);
    const sdkUrl = isSandbox
      ? "https://sandbox.minepi.com/sdk.js"
      : "https://app-cdn.minepi.com/sdk.js";

    // ------------------- LOGGING -------------------
    function log(msg, data) {
      const logs = document.getElementById("logs");
      logs.textContent += msg + (data ? " " + JSON.stringify(data) : "") + "\n";
      console.log(msg, data || "");
    }

    function showError(msg) {
      document.getElementById("errorDisplay").textContent = msg;
      log("ERROR: " + msg);
    }

    // ------------------- GLOBAL ERROR LISTENER -------------------
    window.addEventListener("error", (e) => {
      showError("Global error: " + e.message);
    });

    // ------------------- LOCALHOST MOCK -------------------
    if (location.hostname === "localhost") {
      window.Pi = {
        init: () => log("Mock Pi.init çağrıldı"),
        login: async () => ({ user: { username: "mockUser" } }),
        requestPay: async () => ({ txid: "mockTxid" })
      };
      log("⚠️ Localhost: Mock Pi SDK aktif.");
    }

    // ------------------- LOAD SDK -------------------
    async function loadSdk() {
      if (window.Pi) {
        log("SDK zaten yüklü");
        return;
      }
      try {
        const script = document.createElement("script");
        script.src = sdkUrl;
        script.async = true;
        script.onload = () => {
          log("SDK yüklendi: " + sdkUrl);
        };
        script.onerror = () => {
          showError("SDK yüklenemedi. Lütfen Pi Browser içinde açın.");
        };
        document.head.appendChild(script);
      } catch (err) {
        showError("SDK yükleme hatası: " + err.message);
      }
    }

    // ------------------- INIT -------------------
    async function initSdk() {
      if (!window.Pi) {
        showError("SDK yüklü değil. Önce SDK'yı yükleyin.");
        return;
      }
      try {
        await Pi.init({ appId: APP_ID });
        log("Pi.init başarılı");
      } catch (err) {
        showError("Pi.init hatası: " + err.message);
      }
    }

    // ------------------- LOGIN -------------------
    async function login() {
      if (!window.Pi) {
        showError("Pi SDK yüklü değil.");
        return;
      }
      try {
        const res = await (Pi.login || Pi.authRequest)({ scopes: ["username"] });
        log("Login sonucu:", res);
      } catch (err) {
        showError("Login hatası: " + err.message);
      }
    }

    // ------------------- PAY -------------------
    async function pay() {
      if (!window.Pi) {
        showError("Pi SDK yüklü değil.");
        return;
      }
      try {
        const payment = await (Pi.requestPay || Pi.createPayment)({
          amount: 1,
          memo: "Hybrid Test",
          metadata: { example: "data" }
        });
        log("Ödeme sonucu:", payment);
      } catch (err) {
        showError("Ödeme hatası: " + err.message);
      }
    }

    // ------------------- MEMBERSHIP -------------------
    const form = document.getElementById("membershipForm");
    const statusDiv = document.getElementById("membershipStatus");
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value;
      localStorage.setItem("member", username);
      statusDiv.textContent = "Giriş yapıldı: " + username;
      log("Üye giriş/kayıt:", username);
    });

    // ------------------- MODAL -------------------
    const modal = document.getElementById("modal");
    const closeModal = document.getElementById("closeModal");
    closeModal.onclick = () => (modal.style.display = "none");
    window.onclick = (e) => {
      if (e.target === modal) modal.style.display = "none";
    };

    // ------------------- EVENT BINDINGS -------------------
    document.getElementById("btnLoadSdk").onclick = loadSdk;
    document.getElementById("btnInit").onclick = initSdk;
    document.getElementById("btnLogin").onclick = login;
    document.getElementById("btnPay").onclick = pay;
  </script>
</body>
</html>
