<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgroPi — Payment Test</title>
  <style>
    body{font-family:system-ui,Arial;margin:18px;background:#f7f8fb;color:#111}
    .card{background:#fff;border-radius:10px;padding:18px;box-shadow:0 4px 16px rgba(0,0,0,0.06);max-width:760px;margin:12px auto}
    h1{margin:0 0 14px;font-size:20px}
    label{display:block;margin-top:10px;font-size:13px}
    input,select,button,textarea{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ddd;font-size:14px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    #logBox{height:180px;white-space:pre-wrap;overflow:auto;background:#0f1724;color:#e6fffa;padding:10px;border-radius:6px;font-family:monospace;font-size:12px}
    .controls{display:flex;gap:8px;margin-top:12px}
    button{cursor:pointer}
    .small{width:140px}
    .warn{color:#b45309}
    .ok{color:#065f46}
  </style>
</head>
<body>
  <div class="card">
    <h1>AgroPi — Test Payment Page (sandbox)</h1>

    <div>
      <strong>Kullanıcı:</strong> <span id="userBox">Giriş yok</span>
    </div>

    <label>Ürün
      <select id="product">
        <option value="wheat">Buğday</option>
        <option value="rice">Pirinç</option>
        <option value="tomato">Domates</option>
      </select>
    </label>

    <div class="row">
      <label>Adet (kg)
        <input id="quantity" type="number" value="1" min="1" />
      </label>
      <label>Birim Fiyat (Pi)
        <input id="price" type="number" step="0.000001" value="0.5" />
      </label>
    </div>

    <label>Alıcı adı
      <input id="name" placeholder="Çiftçi adı" />
    </label>

    <div class="controls">
      <button id="loginBtn">Pi ile Giriş</button>
      <button id="logoutBtn" style="display:none">Çıkış</button>
      <button id="payBtn" class="small">Pi ile Öde</button>
    </div>

    <p id="status" class="warn">Durum: Hazır</p>

    <h3 style="margin-top:14px">Log</h3>
    <div id="logBox">—</div>
  </div>

  <script>
  // ---------- Ayarlar ----------
  const PI_APP_ID = ""; // App ID varsa buraya yaz. Şimdilik test için boş.
  const PI_SDK_URL = "https://sdk.minepi.com/pi-sdk.js";
  // ------------------------------

  const $ = sel => document.querySelector(sel);
  const logBox = $("#logBox");
  function log(txt){
    const t = "[" + new Date().toLocaleTimeString() + "] " + txt;
    if(logBox.textContent === "—") logBox.textContent = t;
    else logBox.textContent += "\n" + t;
    logBox.scrollTop = logBox.scrollHeight;
    console.log(t);
  }
  function setStatus(t, cls=""){ $("#status").textContent = "Durum: " + t; $("#status").className = cls; }

  // Pi SDK load
  function ensurePiSdk(){
    return new Promise((resolve,reject)=>{
      if(window.Pi) return resolve(window.Pi);
      const s = document.createElement("script");
      s.src = PI_SDK_URL;
      s.async = true;
      s.onload = () => window.Pi ? resolve(window.Pi) : reject(new Error("Pi SDK yüklendi ama window.Pi yok"));
      s.onerror = ()=> reject(new Error("Pi SDK yüklenemedi"));
      document.head.appendChild(s);
    });
  }

  async function initPi(){
    const Pi = await ensurePiSdk();
    try{
      Pi.init({ version: "2.0", sandbox: true }); // TESTNET
      log("Pi.init({sandbox:true}) OK");
      return Pi;
    }catch(e){
      log("Pi.init hata: " + (e.message||e));
      throw e;
    }
  }

  let piUser = null;
  let piAccessToken = null;

  async function piLogin(){
    try{
      setStatus("Giriş başlatılıyor...", "warn");
      const Pi = await initPi();
      const scopes = ["payments","username","wallet_address"];
      log("authenticate çağrılıyor. appId: " + (PI_APP_ID || "(yok)"));
      const authRes = PI_APP_ID
        ? await Pi.authenticate(scopes, onIncompletePaymentFound, { appId: PI_APP_ID })
        : await Pi.authenticate(scopes, onIncompletePaymentFound);
      piUser = authRes.user;
      piAccessToken = authRes.accessToken;
      $("#userBox").textContent = `${piUser?.username || "—"} (${piUser?.wallet?.address || "—"})`;
      $("#loginBtn").style.display = "none";
      $("#logoutBtn").style.display = "inline-block";
      setStatus("Giriş başarılı", "ok");
      log("Auth OK: " + JSON.stringify({username:piUser?.username, wallet:piUser?.wallet?.address}));
    }catch(err){
      setStatus("Giriş başarısız: " + (err?.message || err), "warn");
      log("authenticate hata: " + (err?.message || JSON.stringify(err)));
    }
  }

  function piLogout(){
    piUser = null; piAccessToken = null;
    $("#userBox").textContent = "Giriş yok";
    $("#loginBtn").style.display = "inline-block";
    $("#logoutBtn").style.display = "none";
    setStatus("Çıkış yapıldı");
    log("Logout");
  }

  async function onIncompletePaymentFound(payment){
    log("Eksik ödeme bulundu: " + JSON.stringify(payment));
    // backend yoksa burada bir şey yapma; prod için approve/complete uçları gerekir.
  }

  async function startPayment(){
    if(!piUser){
      setStatus("Önce Pi ile giriş yapın.", "warn");
      log("startPayment: piUser yok");
      return;
    }
    const product = $("#product").value;
    const quantity = Number($("#quantity").value || 0);
    const price = Number($("#price").value || 0);
    if(!product || !quantity || !price){
      setStatus("Ürün/Miktar/Fiyat eksik.", "warn");
      log("startPayment: eksik alan");
      return;
    }
    const amount = Number((quantity * price).toFixed(6));
    const memo = `AgroPi sipariş: ${product} ${quantity}kg`;
    const metadata = { product, quantity, unit_price: price, buyer: $("#name").value || "—" };

    setStatus("Ödeme popup açılıyor...", "warn");
    log("createPayment çağrısı: " + JSON.stringify({amount,memo,metadata}));

    try{
      const Pi = await initPi();
      const payment = await Pi.createPayment({ amount, memo, metadata }, {
        onReadyForServerApproval: async (paymentId) => {
          log("onReadyForServerApproval: " + paymentId);
          // Prod: burada backend'e /approve çağrısı yap.
        },
        onReadyForServerCompletion: async (paymentId, txid) => {
          log("onReadyForServerCompletion: " + paymentId + " txid:" + (txid||"—"));
          setStatus("Ödeme tamamlandı (test).", "ok");
        },
        onCancel: (paymentId) => {
          log("Ödeme iptal: " + paymentId);
          setStatus("Ödeme iptal edildi.", "warn");
        },
        onError: (err, payment) => {
          log("createPayment onError: " + JSON.stringify(err));
          setStatus("Ödeme hatası: " + (err?.message || JSON.stringify(err)), "warn");
        }
      });
      log("createPayment döndü: " + JSON.stringify(payment));
    }catch(err){
      log("createPayment hata (try/catch): " + (err?.message || JSON.stringify(err)));
      setStatus("Ödeme başlatılamadı: " + (err?.message || err), "warn");
      // Önemli: burada hata mesajı genelde "Origin not allowed" veya "Invalid app id" gibi olur.
    }
  }

  // Event bağlama
  $("#loginBtn").addEventListener("click", piLogin);
  $("#logoutBtn").addEventListener("click", piLogout);
  $("#payBtn").addEventListener("click", startPayment);

  // Başlangıç bilgisi
  log("Sayfa yüklendi. Pi Browser kullanın ve önce 'Pi ile Giriş' deneyin.");
  setStatus("Hazır. Pi Browser'da test et.");
  </script>
</body>
</html>
