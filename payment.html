<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgroPi — Test Ödeme</title>
  <style>
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:#f6f7fb;color:#111}
    header{padding:16px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.1);}
    .container{max-width:600px;margin:30px auto;padding:24px;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);}
    h2{margin-top:0}
    pre{margin-top:20px;padding:12px;background:#0b1220;color:#dbeafe;border-radius:6px;height:260px;overflow:auto;font-size:13px}
    .actions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    button{flex:1;padding:12px;border-radius:6px;border:0;font-weight:600;cursor:pointer;min-width:120px}
    .btn-primary{background:#2b6ef6;color:#fff}
    .btn-secondary{background:#e5e7eb;color:#111}
    input{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;margin-bottom:10px}
  </style>
</head>
<body>
  <header><a href="index.html">← Ana Sayfa</a></header>
  <div class="container">
    <h2>Pi Test Ödeme (Sandbox + Mock)</h2>
    <input id="product" value="AgroPi Test Ürün">
    <input id="amount" value="0.1">
    <input id="note" value="Test siparişi">
    <div class="actions">
      <button id="btnLoad" class="btn-secondary">Load SDK</button>
      <button id="btnInit" class="btn-primary">Init SDK</button>
      <button id="btnLogin" class="btn-secondary">Pi ile Giriş</button>
      <button id="btnPay" class="btn-primary">Gerçek (SDK) Ödeme</button>
      <button id="btnMock" class="btn-secondary">Mock (Test) Ödeme</button>
    </div>
    <pre id="logs"></pre>
  </div>

<script>
const LOG = document.getElementById("logs");
function log(...a){
  LOG.textContent += new Date().toISOString()+" "+a.join(" ")+"\n";
  LOG.scrollTop = LOG.scrollHeight;
}

// App ID (sandbox için)
const APP_ID="agropi-e19dcb997017c03d";
const SDK_URL="https://sdk.minepi.com/pi-sdk.js";

// SDK load
function loadSdk(){
  if(window.Pi){ log("SDK zaten yüklü"); return Promise.resolve(); }
  return new Promise((res,rej)=>{
    const s=document.createElement("script");
    s.src=SDK_URL;
    s.onload=()=>{ log("SDK loaded"); res(); };
    s.onerror=()=>{ log("SDK load error"); rej(); };
    document.head.appendChild(s);
  });
}

// Init SDK
function initPi(){
  try{
    Pi.init({ appId:APP_ID, version:"2.0", sandbox:true });
    log("Pi.init OK ("+APP_ID+") [SANDBOX]");
  }catch(e){ log("Pi.init error",e); }
}

// Login
function doLogin(){
  try{
    Pi.authenticate(
      ["username","payments"], 
      auth => log("Login success", JSON.stringify(auth)),
      err  => log("Login error", JSON.stringify(err))
    );
    log("Login requested");
  }catch(e){ log("Login exception",e); }
}

// Real (SDK) Payment
function doPay(){
  try{
    Pi.createPayment(
      {
        amount: parseFloat(amount.value),
        memo: note.value,
        metadata: { product: product.value },
        currency: "PI"
      },
      payment => log("Payment success (SDK)", JSON.stringify(payment)),
      error   => log("Payment error (SDK)", JSON.stringify(error))
    );
    log("Payment requested (SDK)");
  }catch(e){ log("Payment exception (SDK)", e); }
}

// Mock (Fake) Payment
function doMock(){
  log("Mock payment started...");
  setTimeout(()=>{
    const fake = {
      id: "mock-"+Math.floor(Math.random()*10000),
      product: product.value,
      amount: amount.value,
      status: "COMPLETED",
      txid: "FAKE1234567890"
    };
    log("Payment success (MOCK)", JSON.stringify(fake));
  }, 1000);
}

btnLoad.onclick = ()=>loadSdk();
btnInit.onclick = ()=>initPi();
btnLogin.onclick = ()=>doLogin();
btnPay.onclick = ()=>doPay();
btnMock.onclick = ()=>doMock();
</script>
</body>
</html>
